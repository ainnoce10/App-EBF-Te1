-- 0. NETTOYAGE (ATTENTION : Supprime les tables existantes pour éviter les erreurs)
drop publication if exists supabase_realtime;
drop table if exists public.stock cascade;
drop table if exists public.interventions cascade;
drop table if exists public.transactions cascade;
drop table if exists public.employees cascade;
drop table if exists public.ticker_messages cascade;

-- 1. Activer le Temps Réel (Realtime)
create publication supabase_realtime for all tables;

-- 2. Création de la table STOCK
create table public.stock (
  id text primary key,
  name text not null,
  description text, -- Nouveau champ
  category text,
  quantity integer default 0,
  threshold integer default 5,
  "unitPrice" numeric default 0,
  supplier text,
  site text,
  "imageUrls" text[],
  "technicalSheetUrl" text, -- Nouveau champ
  specs jsonb default '{}'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Création de la table INTERVENTIONS (Techniciens)
create table public.interventions (
  id text primary key,
  client text,
  "clientPhone" text, -- Nouveau champ: numéro du client
  domain text, -- Nouveau champ: 'Électricité', 'Bâtiment', 'Froid'
  "interventionType" text, -- Nouveau champ: 'Dépannage', 'Expertise', etc.
  description text,
  technician text,
  status text, -- 'En cours', 'Terminé', etc.
  date date,
  site text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Création de la table TRANSACTIONS (Comptabilité/Caisse)
create table public.transactions (
  id text primary key,
  type text, -- 'Recette' ou 'Dépense'
  category text,
  amount numeric default 0,
  date date,
  description text,
  site text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. Création de la table EMPLOYEES (RH)
create table public.employees (
  id text primary key,
  name text,
  role text,
  site text,
  status text, -- 'Actif', 'Congés'
  "entryDate" date,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. Création de la table TICKER_MESSAGES (Bandeau TV)
create table public.ticker_messages (
  id bigint generated by default as identity primary key,
  content text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. Configuration de la sécurité (Row Level Security)
-- Stock
alter table public.stock enable row level security;
create policy "Public Access Stock" on public.stock for all using (true) with check (true);

-- Interventions
alter table public.interventions enable row level security;
create policy "Public Access Interventions" on public.interventions for all using (true) with check (true);

-- Transactions
alter table public.transactions enable row level security;
create policy "Public Access Transactions" on public.transactions for all using (true) with check (true);

-- Employees
alter table public.employees enable row level security;
create policy "Public Access Employees" on public.employees for all using (true) with check (true);

-- Messages TV
alter table public.ticker_messages enable row level security;
create policy "Public Access Ticker" on public.ticker_messages for all using (true) with check (true);

-- 8. INSERTION DE DONNÉES DE DÉMARRAGE (Optionnel - pour ne pas avoir une app vide)
insert into public.stock (id, name, description, category, quantity, threshold, "unitPrice", supplier, site, "imageUrls", specs)
values 
('STK-001', 'Câble R2V 3G2.5mm²', 'Câble électrique rigide pour installation fixe industrielle ou domestique.', 'Électricité', 500, 100, 25000, 'ElecPro', 'Abidjan', ARRAY['https://images.unsplash.com/photo-1558402529-d2638a7023e9?auto=format&fit=crop&q=80&w=1200'], '{"Type": "R2V"}'::jsonb),
('STK-002', 'Disjoncteur 16A', 'Disjoncteur magnéto-thermique pour protection des circuits.', 'Électricité', 15, 20, 3500, 'ElecPro', 'Bouaké', ARRAY['https://images.unsplash.com/photo-1581092160607-ee22621dd758?auto=format&fit=crop&q=80&w=1200'], '{"Calibre": "16A"}'::jsonb);

insert into public.ticker_messages (content) values 
('Bienvenue chez EBF - Votre partenaire technique.'),
('Promotion : -15% sur les câbles cette semaine !');